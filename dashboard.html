<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Pre-Retirement Academy</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">


  <!-- Inline styles for layout (left sidebar, responsive bottom nav) -->
  <style>
:root {
  --accent: #ff7a00;
  --accent-2: #6c63ff;
  --card-radius: 1rem;
  --sidebar-width: 230px;
}

body {
  background: #f5f6f8;
  font-family: "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
  margin: 0;
  color: #222;
}

/* Layout */
.dashboard-container {
  display: flex;
  min-height: 100vh;
  align-items: flex-start; /* fixed stretch issue */
}

/* LEFT SIDEBAR */
.dashboard-sidebar {
  width: var(--sidebar-width);
  min-width: var(--sidebar-width);
  background: var(--accent);
  color: #fff;
  display: flex;
  flex-direction: column;
  position: fixed;
  left: 0;
  top: 0;
  bottom: 0;
  padding: 24px 12px;
  gap: 12px;
  z-index: 1050;
  box-shadow: 0 2px 10px rgba(0,0,0,0.07);
}

.sidebar-top {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.sidebar-avatar {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid rgba(255,255,255,0.15);
  background: rgba(255,255,255,0.06);
}

.sidebar-name {
  font-weight: 600;
  text-align: center;
}

.sidebar-dept {
  font-size: 0.85rem;
  opacity: 0.9;
}

.sidebar-nav {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.sidebar-nav a {
  color: #fff;
  text-decoration: none;
  width: 100%;
  display: flex;
  gap: 12px;
  align-items: center;
  padding: 10px 12px;
  border-radius: 8px;
  transition: background .15s, transform .08s;
  font-size: 0.95rem;
}

.sidebar-nav a i {
  font-size: 1.15rem;
  width: 22px;
  text-align: center;
}

.sidebar-nav a:hover {
  background: rgba(255,255,255,0.08);
  transform: translateY(-2px);
}

.sidebar-actions {
  display:flex;
  flex-direction: column;
  gap: 8px;
  width: 100%;
  margin-top: 8px;
}

/* Logout at bottom */
.sidebar-bottom {
  margin-top: auto;
  width: 100%;
  display:flex;
  flex-direction: column;
  gap: 8px;
  align-items: center;
}

.logout-btn {
  width: 100%;
  background: rgba(255,255,255,0.08);
  color: #fff;
  border: none;
  padding: 10px 12px;
  border-radius: 8px;
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:center;
}

.logout-btn:hover {
  background: rgba(255,255,255,0.12);
}

/* MAIN CONTENT (pushed by sidebar) */
.dashboard-main {
  margin-left: var(--sidebar-width);
  flex: 1;
  padding: 28px;
  max-width: calc(100% - var(--sidebar-width));
  width: 100%;
}

.dashboard-main .card {
  border: none;
  border-radius: var(--card-radius);
  box-shadow: 0 6px 18px rgba(36,37,38,0.06);
  width: 100%;
}

/* Charts fluid fix */
.dashboard-main canvas {
  width: 100% !important;
  height: auto !important;
}

/* Bio card layout */
.bio-card p {
  margin-bottom: 0.4rem;
}

/* Footer bottom nav (mobile only) */
.dashboard-sidebar .mobile-nav {
  display: none;
}

/* Responsiveness: collapse sidebar into bottom nav */
@media (max-width: 768px) {
  .dashboard-sidebar {
    position: fixed;
    left: 0;
    bottom: 0;
    top: auto;
    width: 100%;
    height: auto;
    flex-direction: row;
    padding: 8px 6px;
    gap: 0;
  }

  .sidebar-top,
  .sidebar-nav,
  .sidebar-actions,
  .sidebar-bottom {
    display: none;
  }

  /* show compact nav items horizontally */
  .dashboard-sidebar .mobile-nav {
    display:flex;
    width: 100%;
    justify-content: space-around;
    align-items:center;
    gap: 4px;
  }

  .dashboard-sidebar a.mobile-link {
    display:flex;
    flex-direction:column;
    align-items:center;
    font-size: 0.75rem;
    color:#fff;
    text-decoration:none;
    padding:6px 2px;
  }

  .dashboard-main {
    margin-left: 0;
    max-width: 100% !important; /* fix squish issue */
    padding: 20px;
    padding-bottom: 86px; /* room for bottom nav */
  }

  .dashboard-main .card {
    width: 100%;
  }

  .dashboard-main canvas {
    max-width: 100%;
  }

  .dashboard-footer {
    display: none; /* not needed because sidebar is bottom nav */
  }
}

/* Small visual tweaks */
.small-muted {
  color: #6b6b6b;
}

.card-title {
  font-weight: 700;
}

/* Limit chart sizes on desktops */
@media (min-width: 992px) {
  .dashboard-main canvas {
    max-width: 480px;   /* cap chart width */
    margin: 0 auto;     /* center charts */
    display: block;
  }

  /* For side-by-side charts in progress dashboard */
  .dashboard-main .row .col-md-6 canvas {
    max-width: 360px;   /* a bit smaller when side by side */
  }
}


/* Retirement Planner Section */
.planner-section {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.05);
}

.planner-section h2 {
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: #333;
}

.planner-slider {
  margin: 1.5rem 0;
}

.planner-slider label {
  font-size: 0.95rem;
  font-weight: 500;
  color: #444;
  display: block;
  margin-bottom: 0.6rem;
}

/* Sleeker range inputs */
.planner-slider input[type="range"] {
  -webkit-appearance: none;
  width: 100%;
  height: 6px;
  border-radius: 4px;
  background: #f1f1f1;
  cursor: pointer;
  accent-color: #ff7a00;
}

.planner-slider input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #ff7a00;
  border: 2px solid #fff;
  box-shadow: 0 0 4px rgba(0,0,0,0.2);
  transition: transform 0.2s;
}

.planner-slider input[type="range"]::-webkit-slider-thumb:hover {
  transform: scale(1.1);
}

.planner-slider input[type="range"]::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #ff7a00;
  border: 2px solid #fff;
  box-shadow: 0 0 4px rgba(0,0,0,0.2);
  transition: transform 0.2s;
}

.planner-slider input[type="range"]::-moz-range-thumb:hover {
  transform: scale(1.1);
}

.planner-value {
  font-size: 1rem;
  font-weight: 600;
  color: #6c63ff;
  margin-top: 0.5rem;
}

#plannerChart {
  max-width: 600px;
  margin: 20px auto 40px auto; /* extra bottom margin to clear text */
  display: block;
}

/* Projection summary */
.planner-projection {
  font-size: 1.1rem;
  font-weight: 600;
  margin-top: 1rem;
  color: #333;
  text-align: center;
}

.planner-projection span {
  color: #ff7a00;
  font-weight: 700;
}

/* Planner wrapper: fixed height + constrained width */
.planner-wrap {
  max-width: 720px;
  height: 320px;
  margin: 0 auto;
}

/* Force planner canvas to exactly fill wrapper */
.planner-wrap > canvas {
  width: 100% !important;
  height: 100% !important;
  display: block;
  padding: 20px 0;
}

.save-now, .savings-log {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  margin-top: 20px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.05);
}

.save-now h3, .savings-log h3 {
  font-size: 1.2rem;
  margin-bottom: 1rem;
  color: #333;
}

.save-now label, .save-now input, .save-now select {
  display: block;
  margin-bottom: 12px;
  width: 100%;
}

.save-now input, .save-now select {
  padding: 8px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.95rem;
}

.save-now button {
  background: #6c63ff;
  color: #fff;
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
  font-weight: 600;
}

.save-now button:hover {
  background: #5848d9;
}

.save-feedback {
  margin-top: 10px;
  font-size: 0.9rem;
  color: #28a745;
}

.savings-log ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.savings-log li {
  padding: 8px 10px;
  border-bottom: 1px solid #eee;
  font-size: 0.95rem;
  display: flex;
  justify-content: space-between;
  color: #444;
}

/* Layout: Save Now left, Savings Log right */
@media (min-width: 992px) {
  .save-now, .savings-log {
    display: inline-block;
    vertical-align: top;
    width: 48%;
  }
  .save-now {
    margin-right: 2%;
  }
}

/* ================================
   Profile Section Styles
================================ */
#profileSection {
  max-width: 800px;
  margin: 0 auto;
  animation: fadeIn 0.4s ease-in-out;
}

#profileSection h4 {
  font-weight: 600;
  color: #333;
}

#profileSection .card {
  border-radius: 12px;
  border: none;
  background: #fff;
}

#profileSection .rounded-circle {
  border: 4px solid #f3f3f3;
  transition: 0.3s ease;
}

#profileSection .rounded-circle:hover {
  transform: scale(1.05);
  border-color: #6c63ff;
}

#profileSection form .form-label {
  font-weight: 500;
  color: #444;
}

#profileSection form .form-control,
#profileSection form textarea {
  border-radius: 8px;
  border: 1px solid #ddd;
  transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

#profileSection form .form-control:focus,
#profileSection form textarea:focus {
  border-color: #6c63ff;
  box-shadow: 0 0 0 0.2rem rgba(108, 99, 255, 0.15);
}

#profileSection button.btn-orange {
  background-color: #ff7a00;
  border: none;
  font-weight: 600;
  border-radius: 8px;
  padding: 10px;
  transition: background-color 0.3s ease-in-out;
}

#profileSection button.btn-orange:hover {
  background-color: #e56d00;
}

/* Profile feedback message */
#profileFeedback {
  font-size: 0.9rem;
  font-weight: 500;
  text-align: center;
}

/* Fade-in animation */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(15px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ================================
   Budget Planner Styles
================================= */
.budget-planner {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.budget-planner h3 {
  font-size: 1.3rem;
  font-weight: 600;
  color: #333;
  margin-bottom: 10px;
}

.budget-planner p {
  font-size: 0.9rem;
  color: #666;
}

.budget-planner label {
  display: block;
  margin-top: 15px;
  font-weight: 500;
  color: #444;
}


/* ================================
   Budget Planner Input Layout
================================= */
.budget-planner .input-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px 20px; /* row gap | column gap */
  margin-top: 15px;
}

.budget-planner .input-group {
  display: flex;
  flex-direction: column;
}

.budget-planner .input-group label {
  font-weight: 500;
  margin-bottom: 6px;
  color: #444;
}

.budget-planner .input-group input[type="number"] {
  width: 100%;
  padding: 10px;
  font-size: 0.95rem;
  border: 1px solid #ddd;
  border-radius: 8px;
  outline: none;
  transition: border 0.2s;
}

.budget-planner .input-group input[type="number"]:focus {
  border-color: #ff9800;
  box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.2);
}

#generateBudgetBtn {
  margin-top: 20px;
  padding: 10px 15px;
  border-radius: 8px;
  font-size: 0.95rem;
  font-weight: 600;
  background-color: #ff9800;
  color: #fff;
  border: none;
  transition: background 0.2s;
}

#generateBudgetBtn:hover {
  background-color: #e68900;
}

#budgetFeedback {
  margin-top: 12px;
  font-weight: 500;
}

#budgetBreakdownList {
  list-style: none;
  padding: 0;
  margin-top: 10px;
}

#budgetBreakdownList li {
  padding: 6px 0;
  border-bottom: 1px dashed #ddd;
  font-size: 0.9rem;
  color: #333;
}

#budgetBreakdownList li strong {
  color: #27ae60;
}

canvas#budgetBreakdownChart {
  margin-top: 20px;
  max-height: 250px;
}

.net-income-box {
  background: #f9f9f9;
  border: 2px solid #ffa500;
  border-radius: 10px;
  text-align: center;
}
.net-income-box h5 {
  margin: 0;
  color: #333;
}
.net-income-box p {
  font-size: 1.2rem;
  font-weight: bold;
  color: #28a745;
}

/* =========================
   LEARN SECTION STYLES
   ========================= */
#learnSection {
  animation: fadeIn 0.4s ease-in-out;
}

/* Header Card */
#learnSection .card {
  border-radius: 1rem;
  border: 1px solid #e5e7eb;
  background-color: #fff;
}

/* Tab Buttons (Courses / Modules / Certificates) */
#learnSection .tab-buttons {
  display: flex;
  gap: 0.75rem;
  margin-top: 1rem;
}

#learnSection .tab-buttons .btn {
  border-radius: 50px;
  padding: 0.4rem 1.2rem;
  font-size: 0.9rem;
  transition: all 0.25s ease-in-out;
}

#learnSection .tab-buttons .btn.active {
  background-color: #0d6efd;
  color: #fff;
  font-weight: 600;
  box-shadow: 0 0 6px rgba(13, 110, 253, 0.3);
}

/* Content Wrapper */
#learnSection .tab-content {
  margin-top: 1.5rem;
}

/* Module Cards */
#learnSection .module-card {
  border: 1px solid #e5e7eb;
  border-radius: 0.75rem;
  padding: 1rem;
  margin-bottom: 1rem;
  transition: all 0.25s ease-in-out;
}

#learnSection .module-card:hover {
  border-color: #0d6efd;
  background-color: #f8faff;
  transform: translateY(-2px);
}

/* Certificate Cards */
#learnSection .certificate-card {
  border: 1px dashed #cbd5e1;
  background-color: #fafafa;
  padding: 1.2rem;
  border-radius: 0.75rem;
  text-align: center;
  margin-bottom: 1rem;
  transition: all 0.25s ease;
}

#learnSection .certificate-card:hover {
  border-color: #0d6efd;
  background-color: #f1f5ff;
}

#learnSection .certificate-card h6 {
  font-weight: 600;
  margin-bottom: 0.5rem;
}

/* Download Button */
#learnSection .download-btn {
  border-radius: 30px;
  padding: 0.35rem 1rem;
  font-size: 0.85rem;
  font-weight: 500;
  transition: background 0.2s ease-in-out;
}

#learnSection .download-btn:hover {
  background-color: #0d6efd;
  color: #fff;
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}


/* Payment Option Icons */
.pay-option {
  width: 60px;
  height: auto;
  cursor: pointer;
  transition: transform 0.2s ease-in-out;
}

.pay-option:hover {
  transform: scale(1.1);
}

  </style>
</head>
<body>

<div class="dashboard-container">

  <!-- LEFT SIDEBAR -->
  <aside class="dashboard-sidebar" aria-label="Primary navigation">
    <!-- Desktop/Tablet full sidebar content -->
    <div class="sidebar-top">
      <img id="sidebarAvatar" class="sidebar-avatar" src="assets/avatar-placeholder.png" alt="avatar">
      <div class="sidebar-name" id="sidebarName">Loading...</div>
      <div class="sidebar-dept small" id="sidebarDept">Fetching...</div>
    </div>

    <nav class="sidebar-nav" role="navigation" aria-label="Main">
      <a href="#" data-section="home"><i class="bi bi-house-door"></i><span>Home</span></a>
      <a href="#" data-section="learn"><i class="bi bi-mortarboard"></i><span>Learn</span></a>
      <a href="#" data-section="plan"><i class="bi bi-graph-up"></i><span>Plan</span></a>
      <a href="#" data-section="profile"><i class="bi bi-person"></i><span>Profile</span></a>
    </nav>

    <div class="sidebar-actions">
      <button class="btn btn-sm btn-light w-100" onclick="openChangePasswordModal && openChangePasswordModal()">Change Password</button>
      <button class="btn btn-sm btn-outline-light w-100" onclick="downloadProfilePDF && downloadProfilePDF()">Download Profile</button>
    </div>

    <!-- Mobile bottom nav (visible only on small screens) -->
    <div class="mobile-nav">
      <a class="mobile-link" href="#" data-section="home"><i class="bi bi-house-door"></i><small>Home</small></a>
      <a class="mobile-link" href="#" data-section="learn"><i class="bi bi-mortarboard"></i><small>Learn</small></a>
      <a class="mobile-link" href="#" data-section="plan"><i class="bi bi-graph-up"></i><small>Plan</small></a>
      <a class="mobile-link" href="#" data-section="profile"><i class="bi bi-person"></i><small>Profile</small></a>
    </div>

    <div class="sidebar-bottom">
      <button class="logout-btn" id="sidebarLogoutBtn" onclick="logoutUser(event)">
        <i class="bi bi-box-arrow-right"></i>
        <span style="font-weight:600;">Logout</span>
      </button>
    </div>
  </aside>

  <!-- MAIN CONTENT (pushed to the right of sidebar) -->
  <main class="dashboard-main">

  <!-- HOME SECTION -->
  <section id="homeSection" class="dashboard-section">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-4">
      <div>
        <h2 class="mb-1">Welcome back, <span id="welcomeName">User</span> ðŸ‘‹</h2>
        <small class="text-muted">Member since <span id="memberSince">2022</span></small>
      </div>
      <img id="homeAvatar" src="assets/avatar-placeholder.png" 
     alt="User Avatar" 
     class="rounded-circle border" 
     width="56" height="56">
    </div>

    <!-- Top Stats Row -->
    <div class="row g-3 mb-3">
      <div class="col-sm-4">
        <div class="card p-3 text-center">
          <h6 class="card-title mb-1">Workshops Enrolled</h6>
          <h3 id="statWorkshops">0</h3>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card p-3 text-center">
          <h6 class="card-title mb-1">Pending Payments</h6>
          <h3 id="statPayments">0</h3>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card p-3 text-center">
          <h6 class="card-title mb-1">Certificates</h6>
          <h3 id="statCertificates">0</h3>
        </div>
      </div>
    </div>

    <!-- Progress Dashboard -->
    <div class="card shadow-sm p-3 mb-4">
      <h6 class="fw-semibold">Progress Dashboard</h6>
      <div class="row text-center">
        <div class="col-md-6 mb-3">
          <canvas id="readinessChart" height="180"></canvas>
          <small class="text-muted">Retirement readiness score</small>
        </div>
        <div class="col-md-6 mb-3">
          <canvas id="savingsChart" height="180"></canvas>
          <small class="text-muted">Monthly/annual savings insight</small>
        </div>
      </div>
      <div class="text-center mt-3">
        <p class="fw-bold">Total Savings: <span id="statTotalSavings">â‚¦0</span></p>
      </div>
    </div>

    <!-- Budgeting -->
    <div class="card shadow-sm p-3 mb-5">
      <h6 class="fw-semibold">Budgeting & Expenses</h6>
      <canvas id="budgetChart" height="180"></canvas>
    </div>
  </section>

  <!-- PROFILE SECTION -->
  <section id="profileSection" class="dashboard-section" action="javascript:void(0);" style="display:none;">
    <div class="card p-4 mb-4 text-center">
      <h4 class="mb-4"><i class="fas fa-user-circle me-2"></i>My Profile</h4>

      <!-- Profile Picture -->
      <div class="mb-4">
        <label for="photoUpload" class="d-block">
          <img id="profilePhotoPreview" src="assets/avatar-placeholder.png" 
               alt="Profile Photo" 
               class="rounded-circle shadow-sm" 
               style="width:140px; height:140px; object-fit:cover; cursor:pointer;">
        </label>
        <input type="file" id="photoUpload" class="d-none" accept="image/*">
        <p class="small text-muted mt-2">Click the image to upload a new photo</p>
      </div>

      <!-- Display-only -->
      <div class="row text-start mb-4">
        <div class="col-md-6">
          <p><strong>Name:</strong> <span id="profileName">Loading...</span></p>
          <p><strong>Email:</strong> <span id="profileEmail">Loading...</span></p>
          <p><strong>Employee ID:</strong> <span id="profileEmp">...</span></p>
          <p><strong>Department:</strong> <span id="profileDept">...</span></p>
        </div>
        <div class="col-md-6">
          <p><strong>Rank:</strong> <span id="profileRank">...</span></p>
          <p><strong>Years to Retirement:</strong> <span id="profileYears">...</span></p>
          <p><strong>Last Login:</strong> <span id="profileLastLogin">...</span></p>
        </div>
      </div>

      <hr>

      <!-- Editable -->
      <form id="profileForm" class="text-start">
        <div class="mb-3">
          <label for="dob" class="form-label">Date of Birth</label>
          <input type="date" id="dob" class="form-control">
        </div>

        <div class="mb-3">
          <label for="bvn" class="form-label">BVN</label>
          <input type="text" id="bvn" class="form-control" maxlength="11" placeholder="Enter BVN">
        </div>

        <div class="mb-3">
          <label for="income" class="form-label">Monthly Income (â‚¦)</label>
          <input type="number" id="income" class="form-control" placeholder="Enter Monthly Income">
        </div>

        <div class="mb-3">
          <label for="family" class="form-label">Family Details</label>
          <textarea id="family" class="form-control" placeholder="E.g. 2 kids in school, spouse working"></textarea>
        </div>

        <button type="submit" class="btn btn-orange w-100">Save Profile</button>
        <p id="profileFeedback" class="mt-2"></p>
      </form>
    </div>
  </section>

  <!-- PLAN SECTION -->
  <section id="planSection" class="dashboard-section" style="display:none;">
    <div class="planner-section card">
      <h2>Personalized Retirement Planner</h2>
      <p>Adjust your plan and see how your future savings could grow.</p>

      <div class="controls">
        <label>Monthly Contribution: 
          <input type="range" id="contributionSlider" min="10000" max="200000" step="5000" value="50000">
          <span id="contributionValue">â‚¦50,000</span>
        </label>

        <label>Retirement Age: 
          <input type="range" id="retirementAgeSlider" min="55" max="70" value="65">
          <span id="retirementAgeValue">65</span>
        </label>

        <label>Scenario:
          <select id="scenarioSelect">
            <option value="0.08">Optimistic (8%)</option>
            <option value="0.05" selected>Moderate (5%)</option>
            <option value="0.03">Pessimistic (3%)</option>
          </select>
        </label>
      </div>

      <canvas id="plannerChart"></canvas>

      <div class="summary">
        <p>By age <span id="summaryAge">65</span>, you may have <strong id="summaryAmount">â‚¦0</strong>.</p>
      </div>

      <div class="save-now card">
        <h3>Save Now</h3>

        <label for="saveAmount">Enter amount to save:</label>
        <input type="number" id="saveAmount" min="1000" step="1000" placeholder="â‚¦10,000">

        <label for="saveMonth">Select Month:</label>
        <select id="saveMonth">
          <option value="January">January</option>
          <option value="February">February</option>
          <option value="March">March</option>
          <option value="April">April</option>
          <option value="May">May</option>
          <option value="June">June</option>
          <option value="July">July</option>
          <option value="August">August</option>
          <option value="September">September</option>
          <option value="October">October</option>
          <option value="November">November</option>
          <option value="December">December</option>
        </select>

        <label for="paymentMethod">Payment Method:</label>
        <select id="paymentMethod">
          <option value="Card">Card</option>
          <option value="Bank Transfer">Bank Transfer</option>
          <option value="Remita">Remita</option>
          <option value="Paystack">Paystack</option>
        </select>

        <button id="saveNowBtn">Save</button>
        <p class="save-feedback" id="saveFeedback"></p>
      </div>

      <div class="savings-history card">
        <h4>Savings History</h4>
        <ul id="savingsList"></ul>
      </div>
    </div>

<!-- Budget Planner -->
<div class="budget-planner card mt-4 p-3">
  <h3>Budget Planner</h3>
  <p>Decide your savings first, then plan your yearly expenses.</p>

  <!-- Annual Gross Income Display -->
  <div class="net-income-box card p-2 mb-3">
    <h5>Your Annual Gross Income:</h5>
    <p id="netAnnualIncome">â‚¦0</p>
  </div>

  <!-- Income & Savings -->
  <div class="input-grid">
    <!-- Monthly Income -->
    <div class="input-group">
      <label for="budgetIncome">Monthly Income:</label>
      <input type="number" id="budgetIncome" readonly>
    </div>

    <!-- Monthly Savings -->
    <div class="input-group">
      <label for="monthlySavings">Monthly Savings:</label>
      <input type="number" id="monthlySavings" min="0" step="1000" placeholder="â‚¦20,000">
    </div>
  </div>

  <div class="input-grid mt-3">
    <!-- Annual Savings -->
    <div class="input-group">
      <label for="annualSavings">Annual Savings:</label>
      <input type="number" id="annualSavings" readonly>
    </div>

    <!-- Annual Spendable Income -->
    <div class="input-group">
      <label for="annualIncome">Annual Spendable Income:</label>
      <input type="number" id="annualIncome" readonly>
    </div>
  </div>

  <!-- Expenses -->
  <h6 class="mt-3">Your Expenses</h6>
  <div class="input-grid">
    <div class="input-group">
      <label for="expenseHousing">Housing / Rent:</label>
      <input type="number" id="expenseHousing" min="0" step="1000" placeholder="â‚¦50,000">
    </div>

    <div class="input-group">
      <label for="expenseHealth">Health:</label>
      <input type="number" id="expenseHealth" min="0" step="1000" placeholder="â‚¦10,000">
    </div>

    <div class="input-group">
      <label for="expenseFood">Food:</label>
      <input type="number" id="expenseFood" min="0" step="1000" placeholder="â‚¦30,000">
    </div>

    <div class="input-group">
      <label for="expenseTransport">Transport:</label>
      <input type="number" id="expenseTransport" min="0" step="1000" placeholder="â‚¦15,000">
    </div>

    <div class="input-group">
      <label for="expenseOther">Other Expenses:</label>
      <input type="number" id="expenseOther" min="0" step="1000" placeholder="â‚¦20,000">
    </div>
  </div>

  <!-- Generate -->
  <button id="generateBudgetBtn" class="btn btn-orange mt-3">Analyze Budget</button>
  <p id="budgetFeedback" class="mt-2"></p>

  <!-- Chart -->
  <canvas id="budgetBreakdownChart" height="200"></canvas>

  <!-- Breakdown List -->
  <div class="mt-3">
    <h6>Proposed Breakdown</h6>
    <ul id="budgetBreakdownList"></ul>
  </div>
</div>


</section>

  <!-- LEARN SECTION -->
<section id="learnSection" class="dashboard-section" style="display:none;">
  <div class="card shadow-sm p-3 mb-4">
    <h6 class="fw-semibold">Learning Hub</h6>
    <p class="text-muted small mb-3">Access workshops, modules, and your earned certificates.</p>

    <!-- Navigation Tabs -->
    <ul class="nav nav-pills mb-3" id="learnTabs">
      <li class="nav-item">
        <button class="nav-link active" data-learn="workshops">Workshops</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-learn="modules">Modules</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-learn="certificates">Certificates</button>
      </li>
    </ul>

    <!-- Workshops -->
<div id="learnWorkshops" class="learn-pane">
  <div class="row g-3">
    <div class="col-md-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h6 class="fw-semibold">Retirement Planning Basics</h6>
          <p class="small text-muted">Learn the fundamentals of financial planning for retirement.</p>
          <button class="btn btn-sm btn-primary enroll-btn" data-course="Retirement Planning Basics">
            Enroll
          </button>
          <button class="btn btn-sm btn-success start-btn ms-2 d-none" data-course="Retirement Planning Basics">
            Start Course
          </button>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h6 class="fw-semibold">Investment & Wealth Growth</h6>
          <p class="small text-muted">Explore strategies to grow wealth safely and sustainably.</p>
          <button class="btn btn-sm btn-primary enroll-btn" data-course="Investment & Wealth Growth">
            Enroll
          </button>
          <button class="btn btn-sm btn-success start-btn ms-2 d-none" data-course="Investment & Wealth Growth">
            Start Course
          </button>
        </div>
      </div>
    </div>
  </div>
</div>


    <!-- Modules -->
<div id="learnModules" class="learn-pane" style="display:none;">
  <!-- Locked Notice -->
  <div id="modulesLocked" class="alert alert-warning small">
    You must enroll in a course to access modules.
  </div>

  <!-- Dynamic Content Container -->
  <div id="modulesContent" style="display:none;">
    <!-- Course-specific content will be injected here -->
  </div>
</div>


    <!-- Certificates -->
    <div id="learnCertificates" class="learn-pane" style="display:none;">
      <div class="alert alert-info small">
        You donâ€™t have any certificates yet. Complete a workshop to unlock your certificate.
      </div>
      <!-- Example certificate card -->
      <!--
      <div class="card shadow-sm mt-2">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h6 class="fw-semibold">Retirement Planning Basics</h6>
            <p class="small text-muted mb-0">Completed on: Sept 30, 2025</p>
          </div>
          <button class="btn btn-sm btn-success" onclick="downloadCertificate('Retirement Planning Basics')">Download PDF</button>
        </div>
      </div>
      -->
    </div>
  </div>
</section>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title fw-semibold">Complete Payment</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <p class="mb-3">Choose a payment method to continue:</p>

        <!-- Payment Options -->
        <div class="d-flex justify-content-center gap-3 mb-4">
          <img src="https://upload.wikimedia.org/wikipedia/commons/0/0e/Paystack_Logo.png"
               alt="Paystack" class="pay-option" data-method="paystack">
          <img src="https://upload.wikimedia.org/wikipedia/commons/8/8d/Remita_Logo.png"
               alt="Remita" class="pay-option" data-method="remita">
          <i class="bi bi-credit-card-fill fs-1 text-primary pay-option" data-method="card"></i>
        </div>

        <!-- Card Payment Form (hidden by default) -->
        <div id="cardPaymentForm" style="display:none;">
          <div class="mb-2">
            <input type="text" class="form-control" placeholder="Card Number">
          </div>
          <div class="d-flex gap-2 mb-2">
            <input type="text" class="form-control" placeholder="MM/YY">
            <input type="text" class="form-control" placeholder="CVV">
          </div>
          <button id="simulatePayBtn" class="btn btn-success w-100">Pay â‚¦5,000</button>
        </div>
      </div>
    </div>
  </div>
</div>

</main>
</div>


<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase + App logic -->

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

  /* ================================
     Global Chart Variables
  ================================= */
  let plannerChart;
  let readinessChart;
  let savingsChart;
  let currentUserId = null;
 

  /* ================================
     Firebase Init
  ================================= */
  const firebaseConfig = {
    apiKey: "AIzaSyC8LEVkxZy6O0wQRyiAAV1Mcou3hBKLWck",
    authDomain: "pre-retirement-academy.firebaseapp.com",
    projectId: "pre-retirement-academy",
    storageBucket: "pre-retirement-academy.firebasestorage.app",
    messagingSenderId: "602910339082",
    appId: "1:602910339082:web:32cdc2fb290bdbb1ff6ff3"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);
   let budgetChartInstance;
 /* ================================
   Auth State
================================= */
onAuthStateChanged(auth, async (user) => {
  if (user) {
    const uid = user.uid;
    currentUserId = uid;
    const docRef = doc(db, "users", uid);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      console.error("No user profile found in Firestore for UID:", uid);
      try { await signOut(auth); } catch (e) { console.error(e); }
      window.location.href = "user.html";
      return;
    }

    const data = docSnap.data();
    window.profileData = data; // allow other code (nav switcher) to read the profile

    // ========= Populate UI =========
    document.getElementById("welcomeName").textContent =
      data.fullName || user.displayName || "User";

    // âœ… Always update avatars if photoURL exists
    if (data.photoURL) {
      const sidebarAvatarEl = document.getElementById("sidebarAvatar");
      if (sidebarAvatarEl) sidebarAvatarEl.src = data.photoURL;

      const homeAvatarEl = document.getElementById("homeAvatar");
      if (homeAvatarEl) homeAvatarEl.src = data.photoURL;

      const profilePhotoEl = document.getElementById("profilePhotoPreview");
      if (profilePhotoEl) profilePhotoEl.src = data.photoURL;
    }

    document.getElementById("sidebarName").textContent = data.fullName || "â€”";
    document.getElementById("sidebarDept").textContent = data.department || "â€”";
    document.getElementById("bioName").textContent = data.fullName || "â€”";
    document.getElementById("bioEmp").textContent = data.employeeId || "â€”";
    document.getElementById("bioDept").textContent = data.department || "â€”";
    document.getElementById("bioRank").textContent = data.rank || "â€”";
    document.getElementById("bioYears").textContent = data.years || data.yearsToRetirement || "â€”";

    document.getElementById("memberSince").textContent =
      new Date(user.metadata.creationTime).toLocaleDateString();
    if (document.getElementById("lastLogin")) {
      document.getElementById("lastLogin").textContent =
        new Date(user.metadata.lastSignInTime).toLocaleString();
    }

    if (data.stats) {
      document.getElementById("statWorkshops").textContent = data.stats.workshops || 0;
      document.getElementById("statPayments").textContent = data.stats.pendingPayments || 0;
      document.getElementById("statCertificates").textContent = data.stats.certificates || 0;
    }

    // ========= Profile Section =========
    document.getElementById("profileName").textContent = data.fullName || "â€”";
    document.getElementById("profileEmail").textContent = user.email || "â€”";
    document.getElementById("profileEmp").textContent = data.employeeId || "â€”";
    document.getElementById("profileDept").textContent = data.department || "â€”";
    document.getElementById("profileRank").textContent = data.rank || "â€”";
    document.getElementById("profileYears").textContent = data.years || data.yearsToRetirement || "â€”";
    document.getElementById("profileLastLogin").textContent =
      new Date(user.metadata.lastSignInTime).toLocaleString();

    // âœ… Only update form fields if present
    if (document.getElementById("dob")) document.getElementById("dob").value = data.dob || "";
    if (document.getElementById("bvn")) document.getElementById("bvn").value = data.bvn || "";
    if (document.getElementById("income")) document.getElementById("income").value = data.income || "";
    if (document.getElementById("family")) document.getElementById("family").value = data.family || "";

    if (typeof initBudgetPlanner === "function") {
      initBudgetPlanner(data);
    }


  } else {
    window.location.href = "user.html";
  }
});

  
  /* ================================
     Logout Handler
  ================================= */
  window.logoutUser = async function (event) {
    if (event) event.preventDefault();
    const btn = document.getElementById('sidebarLogoutBtn');
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-box-arrow-right"></i> Logging out...';
    }
    try {
      await signOut(auth);
      window.location.href = "user.html";
    } catch (err) {
      console.error("Logout failed:", err);
      alert("Logout failed. See console for details.");
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.innerHTML =
          '<i class="bi bi-box-arrow-right"></i> <span style="font-weight:600;">Logout</span>';
      }
    }
  };

  /* ================================
     Utility Functions
  ================================= */
  function formatNaira(n) {
    if (isNaN(n)) n = 0;
    return "â‚¦" + Number(n).toLocaleString();
  }

  function fvMonthly(monthlyContribution, years, annualRate = 0.05, initial = 0) {
    const months = Math.max(0, Math.round(years * 12));
    const r = annualRate / 12;
    if (months === 0) return Math.round(initial);
    if (r === 0) return Math.round(initial + monthlyContribution * months);
    const factor = Math.pow(1 + r, months);
    return Math.round(
      initial * factor + monthlyContribution * ((factor - 1) / r)
    );
  }

  function buildSeries(monthly, currentAge, retirementAge, annualRate, initial = 0, maxPoints = 6) {
    const totalYears = Math.max(0, retirementAge - currentAge);
    let step = 1;
    if (totalYears > (maxPoints - 1)) step = Math.ceil(totalYears / (maxPoints - 1));
    const labels = [];
    const data = [];
    for (let y = 0; y <= totalYears; y += step) {
      labels.push(String(currentAge + y));
      data.push(fvMonthly(monthly, y, annualRate, initial));
    }
    if ((currentAge + totalYears).toString() !== labels[labels.length - 1]) {
      labels.push(String(retirementAge));
      data.push(fvMonthly(monthly, totalYears, annualRate, initial));
    }
    return { labels, data };
  }

  /* ================================
     Retirement Planner Chart
  ================================= */
  const contributionSlider = document.getElementById('contributionSlider');
  const contributionValue = document.getElementById('contributionValue');
  const retirementAgeSlider = document.getElementById('retirementAgeSlider');
  const retirementAgeValue = document.getElementById('retirementAgeValue');
  const scenarioSelect = document.getElementById('scenarioSelect');
  const summaryAge = document.getElementById('summaryAge');
  const summaryAmount = document.getElementById('summaryAmount');
  const plannerCanvas = document.getElementById('plannerChart');

  const plannerState = {
    currentAge: (window.__user_age && Number(window.__user_age)) || 30,
    initialSavings: (window.__user_initialSavings && Number(window.__user_initialSavings)) || 0,
    monthlyContribution: contributionSlider ? Number(contributionSlider.value) : 50000,
    retirementAge: retirementAgeSlider ? Number(retirementAgeSlider.value) : 65,
    annualRate: scenarioSelect ? parseFloat(scenarioSelect.value) : 0.05
  };

  function renderPlannerFromState () {
    if (!plannerCanvas) return;

    // ensure wrapper exists
    let wrapper = plannerCanvas.closest('.planner-wrap');
    if (!wrapper) {
      wrapper = document.createElement('div');
      wrapper.className = 'planner-wrap';
      wrapper.style.maxWidth = '720px';
      wrapper.style.height = '320px';
      wrapper.style.margin = '0 auto';
      plannerCanvas.parentNode.insertBefore(wrapper, plannerCanvas);
      wrapper.appendChild(plannerCanvas);
    }

    plannerCanvas.style.width = '100%';
    plannerCanvas.style.height = '100%';
    plannerCanvas.style.display = 'block';
    if (plannerCanvas.hasAttribute('height')) plannerCanvas.removeAttribute('height');

    // destroy old
    if (plannerChart) plannerChart.destroy();

    const series = buildSeries(
      plannerState.monthlyContribution,
      plannerState.currentAge,
      plannerState.retirementAge,
      plannerState.annualRate,
      plannerState.initialSavings,
      6
    );

    plannerChart = new Chart(plannerCanvas, {
      type: 'line',
      data: {
        labels: series.labels,
        datasets: [{
          label: 'Projected Savings (â‚¦)',
          data: series.data,
          borderColor: '#6c63ff',
          backgroundColor: 'rgba(108,99,255,0.12)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            ticks: {
              callback: function(val) {
                return typeof val === 'number' ? 'â‚¦' + val.toLocaleString() : val;
              }
            }
          }
        }
      }
    });

    if (summaryAge) summaryAge.textContent = plannerState.retirementAge;
    if (summaryAmount) summaryAmount.textContent =
      formatNaira(series.data[series.data.length - 1]);
  }

  if (contributionSlider) {
    contributionValue.textContent = formatNaira(plannerState.monthlyContribution);
    contributionSlider.addEventListener('input', (e) => {
      plannerState.monthlyContribution = Number(e.target.value || 0);
      contributionValue.textContent = formatNaira(plannerState.monthlyContribution);
      renderPlannerFromState();
    });
  }

  if (retirementAgeSlider) {
    retirementAgeValue.textContent = plannerState.retirementAge;
    retirementAgeSlider.addEventListener('input', (e) => {
      plannerState.retirementAge = Number(e.target.value || plannerState.retirementAge);
      retirementAgeValue.textContent = plannerState.retirementAge;
      renderPlannerFromState();
    });
  }

  if (scenarioSelect) {
    scenarioSelect.addEventListener('change', (e) => {
      plannerState.annualRate = parseFloat(e.target.value || plannerState.annualRate);
      renderPlannerFromState();
    });
  }

  // expose renderer for the nav switcher
  window.renderPlanChart = renderPlannerFromState;

  /* ================================
     Save Now + Progress Dashboard
  ================================= */
  let totalSavings = 0;
  const saveBtn = document.getElementById("saveNowBtn");
  const saveInput = document.getElementById("saveAmount");
  const saveMonthSelect = document.getElementById("saveMonth");
  const paymentMethodSelect = document.getElementById("paymentMethod");
  const saveFeedback = document.getElementById("saveFeedback");
  const savingsList = document.getElementById("savingsList");
  const totalSavingsEl = document.getElementById("statTotalSavings");

  const readinessCtx = document.getElementById('readinessChart');
  if (readinessCtx) {
    readinessChart = new Chart(readinessCtx, {
      type: 'doughnut',
      data: {
        labels: ['Ready', 'Remaining'],
        datasets: [{
          data: [0, 100],
          backgroundColor: ['#6c63ff', '#e0e0e0']
        }]
      },
      options: {
        cutout: '70%',
        plugins: { legend: { display: false }, tooltip: { enabled: false } }
      },
      plugins: [{
        id: 'centerText',
        afterDraw: (chart) => {
          const { width, height, ctx } = chart;
          ctx.save();
          const percent = chart.data.datasets[0].data[0];
          const value = percent + "%";
          ctx.font = `${(height / 6).toFixed(0)}px Segoe UI`;
          ctx.fillStyle = "#333";
          ctx.textBaseline = "middle";
          const textX = Math.round((width - ctx.measureText(value).width) / 2);
          const textY = height / 2;
          ctx.fillText(value, textX, textY);
          ctx.restore();
        }
      }]
    });
  }

  const savingsCtx = document.getElementById('savingsChart');
  if (savingsCtx) {
    savingsChart = new Chart(savingsCtx, {
      type: 'bar',
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
          label: 'Monthly Savings (â‚¦)',
          data: [0, 0, 0, 0, 0, 0],
          backgroundColor: '#6c63ff'
        }]
      },
      options: { plugins: { legend: { display: false } } }
    });
  }

  if (saveBtn && saveInput && totalSavingsEl) {
    function simulatePayment(amount, month, method) {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          if (Math.random() > 0.1) resolve();
          else reject();
        }, 1000);
      });
    }

    saveBtn.addEventListener("click", () => {
      const amount = parseInt(saveInput.value);
      const month = saveMonthSelect.value;
      const method = paymentMethodSelect.value;

      if (isNaN(amount) || amount <= 0) {
        saveFeedback.textContent = "Please enter a valid amount.";
        saveFeedback.style.color = "#e74c3c";
        return;
      }

      simulatePayment(amount, month, method)
        .then(() => {
          totalSavings += amount;
          totalSavingsEl.textContent = "â‚¦" + totalSavings.toLocaleString();

          const goal = 1000000;
          const readinessPercent = Math.min(Math.round((totalSavings / goal) * 100), 100);
          if (readinessChart) {
            readinessChart.data.datasets[0].data = [readinessPercent, 100 - readinessPercent];
            readinessChart.update();
          }

          const monthMap = {
            January: "Jan", February: "Feb", March: "Mar",
            April: "Apr", May: "May", June: "Jun",
            July: "Jul", August: "Aug", September: "Sep",
            October: "Oct", November: "Nov", December: "Dec"
          };
          const shortMonth = monthMap[month] || month;
          if (savingsChart) {
            const monthIndex = savingsChart.data.labels.indexOf(shortMonth);
            if (monthIndex !== -1) {
              savingsChart.data.datasets[0].data[monthIndex] += amount;
              savingsChart.update();
            }
          }

          saveFeedback.textContent =
            `â‚¦${amount.toLocaleString()} saved successfully for ${month}.`;
          saveFeedback.style.color = "#00b894";

          const li = document.createElement("li");
          li.textContent = `â‚¦${amount.toLocaleString()} - ${month}`;
          if (savingsList) savingsList.appendChild(li);

          saveInput.value = "";
          saveMonthSelect.selectedIndex = 0;
          paymentMethodSelect.selectedIndex = 0;
        })
        .catch(() => {
          saveFeedback.textContent = "Payment failed. Please try again.";
          saveFeedback.style.color = "red";
        });
    });
  }

  /* ================================
     Budget Chart
  ================================= */
  const budgetCtx = document.getElementById('budgetChart');
  if (budgetCtx) {
  budgetChartInstance = new Chart(budgetCtx, {
    type: 'pie',
    data: {
      labels: ['Housing', 'Health', 'Leisure', 'Others'],
      datasets: [{
        data: [40, 25, 20, 15],
        backgroundColor: ['#ff7a00', '#6c63ff', '#00b894', '#bbb']
      }]
    }
  });
}


// ================================
// Robust Nav Switcher + Budget Planner + Learn Hook (fixed)
// ================================
document.addEventListener("DOMContentLoaded", function () {
  const navLinks = document.querySelectorAll(".sidebar-nav a[data-section], .mobile-nav a[data-section]");
  const main = document.querySelector("main.dashboard-main") || document.querySelector("main");

  // safe global
  window.budgetChartInstance = window.budgetChartInstance || null;
  let budgetPlannerInitialized = false;

  function findTargetForSection(section) {
    // try common id/name patterns
    const candidates = [section + "Section", section, section.toLowerCase() + "Section", section + "-section"];
    for (const id of candidates) {
      const el = document.getElementById(id);
      if (el) return el;
    }

    // special fallbacks
    if (section === "plan") {
      return document.getElementById("planSection")
        || document.querySelector(".planner-section")
        || document.querySelector("#plannerChart")?.closest(".planner-section")
        || null;
    }

    if (section === "profile") {
      return document.getElementById("profileSection")
        || document.querySelector(".bio-card")
        || null;
    }

    if (section === "learn") {
      return document.getElementById("learnSection")
        || document.querySelector(".learn-section")
        || null;
    }

    return null;
  }

  function showSectionByName(section) {
    if (!main) return;
    const header = main.querySelector(".d-flex.align-items-center") || main.firstElementChild;
    const children = Array.from(main.children);
    const target = findTargetForSection(section);

    if (target) {
      children.forEach(ch => {
        if (ch === header) { ch.style.display = ""; return; }
        if (ch === target || ch.contains(target) || target.contains(ch)) ch.style.display = "";
        else ch.style.display = "none";
      });
    } else {
      // fallback: show header + either home or nothing
      if (section === "home") {
        children.forEach(ch => {
          if (ch === header) { ch.style.display = ""; return; }
          if (ch.id === "profileSection") ch.style.display = "none";
          else ch.style.display = "";
        });
      } else {
        children.forEach(ch => {
          if (ch === header) ch.style.display = "";
          else ch.style.display = "none";
        });
      }
    }

    // set active class on sidebar / mobile nav
    navLinks.forEach(link => link.classList.toggle("active", link.getAttribute("data-section") === section));

    // small delay to let DOM paint, then init section-specific things
    setTimeout(() => {
      if (section === "plan") {
        if (typeof window.renderPlanChart === "function") window.renderPlanChart();

        // init budget planner once (use profile if available)
        const profile = window.profileData || {};
        if (!budgetPlannerInitialized && typeof initBudgetPlanner === "function") {
          initBudgetPlanner(profile);
          budgetPlannerInitialized = true;
        } else {
          // refresh income if profile changed
          if (budgetPlannerInitialized && profile && profile.income) {
            const inc = document.getElementById("budgetIncome");
            if (inc) { inc.value = profile.income; inc.readOnly = true; }
          }
        }

        try { if (window.budgetChartInstance) { window.budgetChartInstance.resize(); window.budgetChartInstance.update(); } } catch(e){}
        try { if (plannerChart) { plannerChart.resize(); plannerChart.update(); } } catch(e){}
        try { if (readinessChart) { readinessChart.resize(); readinessChart.update(); } } catch(e){}
        try { if (savingsChart) { savingsChart.resize(); savingsChart.update(); } } catch(e){}
      } else if (section === "home") {
        try { if (readinessChart) { readinessChart.resize(); readinessChart.update(); } } catch(e){}
        try { if (savingsChart) { savingsChart.resize(); savingsChart.update(); } } catch(e){}
      } else if (section === "learn") {
        setupLearnHandlers(); // safe to call repeatedly - it guards itself
      }
    }, 80);
  }

  // attach nav link behavior
  navLinks.forEach(link => {
    link.addEventListener("click", function (ev) {
      ev.preventDefault();
      const section = this.getAttribute("data-section");
      if (section) showSectionByName(section);
    });
  });

  // Delegated handlers and learn tab setup (attached once)
  function setupLearnHandlers() {
    // Tab switching (bind once per tab)
    const tabs = document.querySelectorAll("#learnTabs .nav-link");
    if (tabs.length) {
      tabs.forEach(tab => {
        if (tab.dataset.learnBound === "true") return;
        tab.dataset.learnBound = "true";
        tab.addEventListener("click", (e) => {
          e.preventDefault();
          tabs.forEach(b => b.classList.remove("active"));
          tab.classList.add("active");
          const target = tab.getAttribute("data-learn");
          document.querySelectorAll(".learn-pane").forEach(p => p.style.display = "none");
          const pane = document.getElementById("learn" + target.charAt(0).toUpperCase() + target.slice(1));
          if (pane) pane.style.display = "block";
        });
      });

      // show currently active tab or first tab
      const activeTab = document.querySelector("#learnTabs .nav-link.active") || tabs[0];
      if (activeTab) activeTab.click();
    }

    // Enroll button (delegated) - bind once globally
      if (!window._learnEnrollBound) {
        window._learnEnrollBound = true;
        document.addEventListener("click", (e) => {
          const enrollBtn = e.target.closest(".enroll-btn");
          if (!enrollBtn) return;
          e.preventDefault();

          // call your payment modal logic here, or just dispatch to a handler
          handleEnrollClick(enrollBtn);
        });
      }
  }

  // default landing
  showSectionByName("home");
});





  /* ================================
     Passport/photo upload preview
  ================================= */
  const photoUpload = document.getElementById('photoUpload');
  const profilePhotoPreview = document.getElementById('profilePhotoPreview');

  if (photoUpload && profilePhotoPreview) {
    photoUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          profilePhotoPreview.src = ev.target.result;
          profilePhotoPreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });
  }

// ================================
// Load Profile function
// ================================
async function loadProfile(uid) {
  if (!uid) return;
  const docRef = doc(db, "users", uid);
  const docSnap = await getDoc(docRef);

  if (!docSnap.exists()) {
    console.error("No user profile found in Firestore for UID:", uid);
    return;
  }

  const data = docSnap.data();
  const user = auth.currentUser;

  // Sidebar & Bio
  document.getElementById("profileName").textContent = data.fullName || "â€”";
  document.getElementById("profileEmail").textContent = user?.email || "â€”";
  document.getElementById("profileEmp").textContent = data.employeeId || "â€”";
  document.getElementById("profileDept").textContent = data.department || "â€”";
  document.getElementById("profileRank").textContent = data.rank || "â€”";
  document.getElementById("profileYears").textContent =
    data.years || data.yearsToRetirement || "â€”";
  document.getElementById("profileLastLogin").textContent =
    new Date(user?.metadata.lastSignInTime).toLocaleString();

  // Form fields
  if (document.getElementById("dob")) document.getElementById("dob").value = data.dob || "";
  if (document.getElementById("bvn")) document.getElementById("bvn").value = data.bvn || "";
  if (document.getElementById("income")) document.getElementById("income").value = data.income || "";
  if (document.getElementById("family")) document.getElementById("family").value = data.family || "";

  // Profile photo
  if (data.photoURL) {
    document.getElementById("profilePhotoPreview").src = data.photoURL;
    const homeAvatarEl = document.getElementById("homeAvatar");
    if (homeAvatarEl) homeAvatarEl.src = data.photoURL;
  }
}

// Nav Switcher hook for Profile
document.querySelectorAll(".sidebar-nav a, .mobile-nav a").forEach(link => {
  link.addEventListener("click", async (e) => {
    const section = e.currentTarget.getAttribute("data-section");
    if (section === "profile" && currentUserId) {
      await loadProfile(currentUserId);
      bindProfileForm(); // <-- attach the save handler dynamically
    }
  });
});

// Function to attach Save Profile handler
function bindProfileForm() {
  const profileForm = document.getElementById("profileForm");
  const feedback = document.getElementById("profileFeedback");
  const photoUpload = document.getElementById("photoUpload");
  let newPhotoFile = null;

  if (!profileForm) {
    console.warn("âš ï¸ profileForm not found when trying to bind");
    return;
  }

  // Avoid multiple bindings
  if (profileForm.dataset.bound === "true") return;
  profileForm.dataset.bound = "true";

  console.log("âœ… Binding Save Profile form");

  if (photoUpload) {
    photoUpload.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        newPhotoFile = file;
        document.getElementById("profilePhotoPreview").src = URL.createObjectURL(file);
        console.log("ðŸ“¸ Selected new photo:", file.name);
      }
    });
  }

  profileForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    console.log("ðŸ’¾ Save profile clicked");

    if (!currentUserId) {
      console.error("âŒ No currentUserId, cannot save profile");
      return;
    }

    feedback.textContent = "Saving...";
    feedback.className = "text-muted";

    try {
      const docRef = doc(db, "users", currentUserId);
      const updates = {
        dob: document.getElementById("dob")?.value || "",
        bvn: document.getElementById("bvn")?.value || "",
        income: document.getElementById("income")?.value || "",
        family: document.getElementById("family")?.value || "",
        updatedAt: new Date().toISOString()
      };

      if (newPhotoFile) {
        const storageRef = ref(storage, `profilePhotos/${currentUserId}/profile.jpg`);
        await uploadBytes(storageRef, newPhotoFile);
        updates.photoURL = await getDownloadURL(storageRef);
        console.log("âœ… Photo uploaded");
      }

      await updateDoc(docRef, updates);
      console.log("âœ… Firestore updated:", updates);

      feedback.textContent = "Profile updated successfully!";
      feedback.className = "text-success";

      await loadProfile(currentUserId);
      newPhotoFile = null;
      if (photoUpload) photoUpload.value = "";
    } catch (err) {
      console.error("âŒ Error updating profile:", err);
      feedback.textContent = "Failed to update profile.";
      feedback.className = "text-danger";
    }
  });
}

// ==================== Budget Planner ====================
// Replace/insert this single initBudgetPlanner implementation (idempotent)
function initBudgetPlanner(profile = {}) {
  // if already bound, just update fields from profile (no re-bind)
  if (initBudgetPlanner._bound) {
    const inc = document.getElementById("budgetIncome");
    if (inc && profile && profile.income) {
      inc.value = profile.income;
      inc.readOnly = true;
      // update annual displays
      const monthly = parseFloat(inc.value) || 0;
      const netAnnualEl = document.getElementById("netAnnualIncome")
                        || document.getElementById("netAnnualInc")
                        || document.getElementById("netAnnual")
                        || null;
      if (netAnnualEl) netAnnualEl.textContent = "â‚¦" + Math.round(monthly * 12).toLocaleString();
      const annualIncomeInput = document.getElementById("annualIncome") || document.getElementById("annualSpendable");
      if (annualIncomeInput) annualIncomeInput.value = Math.round(monthly * 12);
    }
    return;
  }

  initBudgetPlanner._bound = true;

  const incomeInput = document.getElementById("budgetIncome");
  const monthlySavingsInput = document.getElementById("monthlySavings");
  const annualSavingsInput = document.getElementById("annualSavings");
  const annualIncomeInput = document.getElementById("annualIncome");
  const netAnnualEl = document.getElementById("netAnnualIncome")
                    || document.getElementById("netAnnualInc")
                    || document.getElementById("netAnnual")
                    || null;
  const feedback = document.getElementById("budgetFeedback");
  const breakdownList = document.getElementById("budgetBreakdownList");
  const chartCanvas = document.getElementById("budgetBreakdownChart");
  const ctx = chartCanvas ? chartCanvas.getContext("2d") : null;

  // helper to safely parse an input value
  const valOf = (id) => parseFloat(document.getElementById(id)?.value) || 0;

  function updateAnnualDisplays() {
    if (!incomeInput) return;
    const monthly = parseFloat(incomeInput.value) || 0;
    if (annualIncomeInput) annualIncomeInput.value = Math.round(monthly * 12);
    if (netAnnualEl) netAnnualEl.textContent = "â‚¦" + Math.round(monthly * 12).toLocaleString();
  }

  // populate from profile if available
  try {
    if (profile && profile.income && incomeInput) {
      incomeInput.value = profile.income;
      incomeInput.readOnly = true;
    }
    // optional: if profile has saved expenses object, map them
    if (profile && profile.expenses) {
      ["expenseHousing","expenseHealth","expenseFood","expenseTransport","expenseOther"].forEach(key => {
        if (profile.expenses[key] !== undefined) {
          const el = document.getElementById(key);
          if (el) el.value = profile.expenses[key];
        }
      });
    }
  } catch (e) {
    console.warn("initBudgetPlanner populate error:", e);
  }

  // ensure annual displays reflect current income
  updateAnnualDisplays();

  // update when user edits monthly income (if editable)
  if (incomeInput) {
    incomeInput.addEventListener("input", updateAnnualDisplays);
  }

  // monthlySavings -> annual calculations
  if (monthlySavingsInput) {
    monthlySavingsInput.addEventListener("input", () => {
      const monthlyIncome = parseFloat(incomeInput?.value) || 0;
      const monthlySavings = parseFloat(monthlySavingsInput.value) || 0;

      if (monthlySavings > monthlyIncome) {
        alert("Savings cannot be more than your monthly income!");
        monthlySavingsInput.value = "";
        if (annualSavingsInput) annualSavingsInput.value = "";
        if (annualIncomeInput) annualIncomeInput.value = "";
        return;
      }

      if (annualSavingsInput) annualSavingsInput.value = Math.round(monthlySavings * 12);
      if (annualIncomeInput) annualIncomeInput.value = Math.round((monthlyIncome - monthlySavings) * 12);
    });
  }

  // Generate / Analyze button
  const analyzeBtn = document.getElementById("generateBudgetBtn");
  if (analyzeBtn) {
    analyzeBtn.addEventListener("click", () => {
      const income = parseFloat(incomeInput?.value) || 0;

      const expenses = {
        housing: valOf("expenseHousing"),
        health: valOf("expenseHealth"),
        food: valOf("expenseFood"),
        transport: valOf("expenseTransport"),
        other: valOf("expenseOther"),
      };

      const totalExpenses = Object.values(expenses).reduce((a,b)=>a+b,0);
      const savings = Math.round(income - totalExpenses);

      if (feedback) {
        if (savings < 0) {
          feedback.textContent = `âš ï¸ Your expenses exceed your income by â‚¦${Math.abs(savings).toLocaleString()}.`;
          feedback.style.color = "red";
        } else {
          feedback.textContent = `âœ… You can save â‚¦${savings.toLocaleString()} this month.`;
          feedback.style.color = "green";
        }
      }

      if (breakdownList) {
        const safePct = (x) => income ? ` (${((x/income)*100).toFixed(1)}%)` : "";
        breakdownList.innerHTML = `
          <li>Housing: â‚¦${expenses.housing.toLocaleString()}${safePct(expenses.housing)}</li>
          <li>Health: â‚¦${expenses.health.toLocaleString()}${safePct(expenses.health)}</li>
          <li>Food: â‚¦${expenses.food.toLocaleString()}${safePct(expenses.food)}</li>
          <li>Transport: â‚¦${expenses.transport.toLocaleString()}${safePct(expenses.transport)}</li>
          <li>Other: â‚¦${expenses.other.toLocaleString()}${safePct(expenses.other)}</li>
          <li><strong>Savings: â‚¦${savings.toLocaleString()}${safePct(savings)}</strong></li>
        `;
      }

      // chart
      try {
        if (ctx && typeof Chart !== "undefined") {
          if (window.budgetChartInstance) window.budgetChartInstance.destroy();
          window.budgetChartInstance = new Chart(ctx, {
            type: "pie",
            data: {
              labels: ["Housing", "Health", "Food", "Transport", "Other", "Savings"],
              datasets: [{
                data: [
                  expenses.housing,
                  expenses.health,
                  expenses.food,
                  expenses.transport,
                  expenses.other,
                  savings > 0 ? savings : 0
                ],
                // you may already have theme colors, keep them consistent
                backgroundColor: ["#f39c12", "#e74c3c", "#27ae60", "#3498db", "#9b59b6", "#2ecc71"],
              }]
            }
          });
        }
      } catch (e) {
        console.warn("budget chart error:", e);
      }
    });
  }

  // finished binding
  console.debug("initBudgetPlanner: bound and ready");
}

// ================================
// Payment Modal Logic
// ================================
const paymentModal = new bootstrap.Modal(document.getElementById("paymentModal"));
const cardForm = document.getElementById("cardPaymentForm");

// external handler called from delegated click
function handleEnrollClick(enrollBtn) {
  const course = enrollBtn.dataset.course;
  document.querySelector("#paymentModal .modal-title").textContent =
    "Complete Payment for " + course;

  // Hidden input for tracking selected course
  let hiddenInput = document.getElementById("selectedCourse");
  if (!hiddenInput) {
    hiddenInput = document.createElement("input");
    hiddenInput.type = "hidden";
    hiddenInput.id = "selectedCourse";
    document.getElementById("paymentModal").appendChild(hiddenInput);
  }
  hiddenInput.value = course;

  // Just open modal here (donâ€™t hide/show buttons yet!)
  paymentModal.show();
}


// Handle payment method clicks
document.querySelectorAll(".pay-option").forEach(opt => {
  opt.addEventListener("click", () => {
    const method = opt.dataset.method;
    cardForm.style.display = "none"; // reset each time

    if (method === "paystack") {
      window.open("https://paystack.com", "_blank");
    } else if (method === "remita") {
      window.open("https://remita.net", "_blank");
    } else if (method === "card") {
      cardForm.style.display = "block";
    }
  });
});

// Simulate Card Payment
document.getElementById("simulatePayBtn").addEventListener("click", () => {
  setTimeout(() => {
    alert("âœ… Payment Successful!\nYou now have access to this course.");

    const course = document.getElementById("selectedCourse").value;
    const enrollBtn = document.querySelector(`.enroll-btn[data-course="${course}"]`);
    if (enrollBtn) {
      // Hide Enroll
      enrollBtn.classList.add("d-none");

      // Show Start
      const startBtn = enrollBtn.parentElement.querySelector(".start-btn");
      if (startBtn) startBtn.classList.remove("d-none");

      // Mark enrolled
      enrollBtn.dataset.enrolled = "true";
    }

    cardForm.style.display = "none";
    paymentModal.hide();
  }, 1000);
});


// Start Course Button Logic
document.addEventListener("click", (e) => {
  const startBtn = e.target.closest(".start-btn");
  if (!startBtn) return;
  e.preventDefault();

  const courseName = startBtn.dataset.course;

  // ===== Switch Learn Tab to "Modules" =====
  document.querySelectorAll("#learnTabs .nav-link").forEach(btn => btn.classList.remove("active"));
  const modulesTab = document.querySelector('#learnTabs .nav-link[data-learn="modules"]');
  if (modulesTab) modulesTab.classList.add("active");

  document.querySelectorAll(".learn-pane").forEach(pane => pane.style.display = "none");
  document.getElementById("learnModules").style.display = "block";

  // ===== Unlock modules area =====
  document.getElementById("modulesLocked").style.display = "none";
  const modulesContent = document.getElementById("modulesContent");
  modulesContent.style.display = "block";

  // ===== Load course-specific content dynamically =====
  modulesContent.innerHTML = `
  <div class="card p-3 mb-3 shadow-sm">
    <h6 class="fw-semibold">${courseName} - Module 1</h6>
    <p class="small text-muted">Here is your learning material.</p>

    <!-- YouTube Video -->
    <div class="ratio ratio-16x9 mb-3">
      <iframe 
        src="https://www.youtube.com/embed/dQw4w9WgXcQ" 
        title="YouTube video"
        allowfullscreen>
      </iframe>
    </div>

    <!-- Question 1 -->
    <div class="mb-3">
      <p><strong>Q1:</strong> What is the main purpose of retirement planning?</p>
      <button class="btn btn-outline-primary btn-sm">To ensure financial stability after active work life</button>
      <button class="btn btn-outline-primary btn-sm">To buy luxury items only</button>
      <button class="btn btn-outline-primary btn-sm">To avoid paying taxes</button>
    </div>

    <!-- Question 2 -->
    <div class="mb-3">
      <p><strong>Q2:</strong> Which of the following is considered a safe investment option for retirees?</p>
      <button class="btn btn-outline-primary btn-sm">High-risk crypto trading</button>
      <button class="btn btn-outline-primary btn-sm">Government bonds</button>
      <button class="btn btn-outline-primary btn-sm">Unverified Ponzi schemes</button>
    </div>

    <!-- Question 3 -->
    <div class="mb-3">
      <p><strong>Q3:</strong> Why is diversification important in investment?</p>
      <button class="btn btn-outline-primary btn-sm">To reduce risk exposure</button>
      <button class="btn btn-outline-primary btn-sm">To maximize single asset gains</button>
      <button class="btn btn-outline-primary btn-sm">To only invest in real estate</button>
    </div>

    <!-- Question 4 -->
    <div class="mb-3">
      <p><strong>Q4:</strong> What should be considered when planning for long-term wealth growth?</p>
      <button class="btn btn-outline-primary btn-sm">Time horizon & inflation</button>
      <button class="btn btn-outline-primary btn-sm">Impulse buying</button>
      <button class="btn btn-outline-primary btn-sm">Ignoring financial goals</button>
    </div>
  </div>
`;
});


// Quiz logic
document.querySelectorAll(".submit-quiz").forEach(btn => {
  btn.addEventListener("click", () => {
    const quizId = btn.dataset.quiz;
    const selected = document.querySelector(`input[name="quiz${quizId}"]:checked`);
    if (!selected) {
      alert("âš ï¸ Please select an option.");
      return;
    }

    let correctAnswer = null;
    if (quizId === "1") correctAnswer = "b";
    if (quizId === "2") correctAnswer = "b";

    if (selected.value === correctAnswer) {
      alert("âœ… Correct!");
      const currentLesson = btn.closest(".lesson");
      currentLesson.classList.add("d-none");

      const nextLesson = document.querySelector(`#learnModules .lesson[data-lesson="${parseInt(quizId) + 1}"]`);
      if (nextLesson) {
        nextLesson.classList.remove("d-none");
      } else {
        // Course finished
        document.getElementById("courseComplete").classList.remove("d-none");

        // Move certificate
        const certSection = document.getElementById("learnCertificates");
        certSection.innerHTML = `
          <div class="card shadow-sm mt-2">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h6 class="fw-semibold">Retirement Planning Basics</h6>
                <p class="small text-muted mb-0">Completed on: ${new Date().toLocaleDateString()}</p>
              </div>
              <button class="btn btn-sm btn-success" onclick="downloadCertificate('Retirement Planning Basics')">Download PDF</button>
            </div>
          </div>
        `;
      }
    } else {
      alert("âŒ Wrong answer. Try again!");
    }
  });
});
</script>
<!-- Bootstrap JS bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
