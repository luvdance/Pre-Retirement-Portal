<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Pre-Retirement Academy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<!-- Dashboard Section -->
<section class="dashboard-section py-5">
  <div class="container-fluid">
    <div class="row gx-4">

      <!-- Sidebar -->
      <aside class="col-lg-3 mb-4">
        <div class="card sidebar-card p-3 shadow-sm rounded-4">
          <div class="d-flex align-items-center mb-3">
            <img id="sidebarAvatar" src="assets/avatar-placeholder.png" alt="avatar" class="rounded-circle me-3 border" width="64" height="64">
            <div>
              <h5 id="sidebarName" class="mb-0 fw-semibold">Loading...</h5>
              <small id="sidebarDept" class="text-muted">Fetching...</small>
            </div>
          </div>

          <div class="mb-3">
            <div class="small text-muted fw-bold">Quick Actions</div>
            <div class="d-grid gap-2 mt-2">
              <button class="btn btn-outline-primary btn-sm" onclick="openChangePasswordModal()">Change Password</button>
              <button class="btn btn-outline-secondary btn-sm" onclick="downloadProfilePDF()">Download Profile</button>
            </div>
          </div>

          <nav class="nav flex-column mt-3 dashboard-nav">
            <a class="nav-link active" href="#" onclick="showSection('overview')"><i class="bi bi-house-door me-2"></i> Overview</a>
            <a class="nav-link" href="#" onclick="showSection('workshops')"><i class="bi bi-mortarboard me-2"></i> Workshops</a>
            <a class="nav-link" href="#" onclick="showSection('enrollment')"><i class="bi bi-journal-check me-2"></i> My Enrollments</a>
            <a class="nav-link" href="#" onclick="showSection('payments')"><i class="bi bi-credit-card me-2"></i> Payments</a>
            <a class="nav-link" href="#" onclick="showSection('certificates')"><i class="bi bi-award me-2"></i> Certificates</a>
            <a class="nav-link" href="#" onclick="showSection('resources')"><i class="bi bi-folder me-2"></i> Resources</a>
            <a class="nav-link text-danger mt-2" href="#" onclick="logoutUser()"><i class="bi bi-box-arrow-right me-2"></i> Logout</a>
          </nav>
        </div>
      </aside>

      <!-- Main content -->
      <div class="col-lg-9">
        <div class="d-flex align-items-center justify-content-between mb-4">
          <div>
            <h2 class="mb-1">Welcome back, <span id="welcomeName">User</span> ðŸ‘‹</h2>
            <small class="text-muted">Member since <span id="memberSince">...</span></small>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <div class="card shadow-sm p-3 text-center rounded-4">
              <h6 class="fw-bold">Workshops Enrolled</h6>
              <h3 id="statWorkshops">0</h3>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card shadow-sm p-3 text-center rounded-4">
              <h6 class="fw-bold">Pending Payments</h6>
              <h3 id="statPayments">0</h3>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card shadow-sm p-3 text-center rounded-4">
              <h6 class="fw-bold">Certificates Earned</h6>
              <h3 id="statCertificates">0</h3>
            </div>
          </div>
        </div>

        <!-- Bio Section -->
        <div class="card p-3 shadow-sm rounded-4">
          <h5 class="fw-bold mb-3">Bio & Profile</h5>
          <p><strong>Name:</strong> <span id="bioName">...</span></p>
          <p><strong>Employee ID:</strong> <span id="bioEmp">...</span></p>
          <p><strong>Department:</strong> <span id="bioDept">...</span></p>
          <p><strong>Rank:</strong> <span id="bioRank">...</span></p>
          <p><strong>Years to Retirement:</strong> <span id="bioYears">...</span></p>
        </div>

        <!-- Dynamic Sections -->
        <div id="dynamicSection" class="mt-4">
          <!-- Workshops, Enrollments, Payments, etc. will load here -->
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Footer Section -->
<footer class="footer">
  <div class="container">
    <div class="row">
      <!-- Logo and Subscribe -->
      <div class="col-md-4">
        <div class="footer-brand">
          <img src="assets/logo.png" alt="Logo" class="footer-logo">
          <h4 class="mt-2">Pre-Retirement Academy</h4>
        </div>
        <form class="subscribe-form mt-3">
          <label for="subscribe-email" class="form-label">Subscribe to our newsletter</label>
          <div class="input-group">
            <input type="email" id="subscribe-email" class="form-control" placeholder="Enter your email">
            <button type="submit" class="btn btn-orange">Subscribe</button>
          </div>
        </form>
      </div>

      <!-- Navigation Columns -->
      <div class="col-md-4">
        <div class="row">
          <div class="col-6">
            <h5 class="footer-heading">Quick Links</h5>
            <ul class="footer-links">
              <li><a href="#">Home</a></li>
              <li><a href="#">Features</a></li>
              <li><a href="#">About</a></li>
              <li><a href="#">Team</a></li>
              <li><a href="#">FAQs</a></li>
            </ul>
          </div>
          <div class="col-6">
            <h5 class="footer-heading">Resources</h5>
            <ul class="footer-links">
              <li><a href="#">Workshops</a></li>
              <li><a href="#">Enrollment</a></li>
              <li><a href="#">Payments</a></li>
              <li><a href="#">Partners</a></li>
              <li><a href="#">Contact</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Social Media -->
      <div class="col-md-4">
        <h5 class="footer-heading">Follow Us</h5>
        <div class="social-links">
          <a href="#"><i class="fab fa-facebook-f"></i> Facebook</a>
          <a href="#"><i class="fab fa-twitter"></i> Twitter</a>
          <a href="#"><i class="fab fa-linkedin-in"></i> LinkedIn</a>
          <a href="#"><i class="fab fa-instagram"></i> Instagram</a>
        </div>
      </div>
    </div>

    <!-- Bottom Bar -->
    <div class="footer-bottom d-flex justify-content-between align-items-center mt-4">
      <p class="mb-0">Â© 2025 Retirement Corp. All Rights Reserved.</p>
      <div class="footer-policies">
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Service</a>
        <a href="#">Cookie Settings</a>
      </div>
    </div>
  </div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyC8LEVkxZy6O0wQRyiAAV1Mcou3hBKLWck",
    authDomain: "pre-retirement-academy.firebaseapp.com",
    projectId: "pre-retirement-academy",
    storageBucket: "pre-retirement-academy.firebasestorage.app",
    messagingSenderId: "602910339082",
    appId: "1:602910339082:web:32cdc2fb290bdbb1ff6ff3"
  };

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Auth State
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const uid = user.uid;
      const docRef = doc(db, "users", uid);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();

        // Update UI
        document.getElementById("welcomeName").textContent = data.fullName;
        document.getElementById("sidebarName").textContent = data.fullName;
        document.getElementById("sidebarDept").textContent = data.department;
        document.getElementById("bioName").textContent = data.fullName;
        document.getElementById("bioEmp").textContent = data.employeeId;
        document.getElementById("bioDept").textContent = data.department;
        document.getElementById("bioRank").textContent = data.rank;
        document.getElementById("bioYears").textContent = data.years || data.yearsToRetirement || "...";

        // Format dates
        document.getElementById("memberSince").textContent = new Date(user.metadata.creationTime).toLocaleDateString();

        if (document.getElementById("lastLogin")) {
          document.getElementById("lastLogin").textContent = new Date(user.metadata.lastSignInTime).toLocaleString();
        }

      } else {
        // ðŸ”¥ This is the issue. It finds the user, but the document doesn't exist.
        // It then signs out and redirects, creating the immediate logout loop.
        console.error("No user profile found in Firestore for UID:", uid);
        await signOut(auth); // Sign out the user to prevent an endless loop
        window.location.href = "user.html";
      }
    } else {
      // Redirect if logged out
      window.location.href = "user.html";
    }
  });

  // Robust Logout Handler
  window.logoutUser = async function (event) {
    if (event) {
      event.preventDefault();
    }
    const logoutBtn = event?.target;
    if (logoutBtn) {
      logoutBtn.disabled = true;
      logoutBtn.textContent = "Logging out...";
    }
    try {
      await signOut(auth);
      window.location.href = "user.html";
    } catch (err) {
      console.error("Logout failed:", err);
      alert("Logout failed. Check console for details.");
    } finally {
      if (logoutBtn) {
        logoutBtn.disabled = false;
        logoutBtn.textContent = "Logout";
      }
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

